make install
make init-golang-rly
make start-golang-rly

# Store the following account addresses within the current shell env
export WALLET_1=$(icad keys show wallet1 -a --keyring-backend test --home ./data/test-1) && echo $WALLET_1;
export WALLET_2=$(icad keys show wallet2 -a --keyring-backend test --home ./data/test-1) && echo $WALLET_2;
export WALLET_3=$(icad keys show wallet3 -a --keyring-backend test --home ./data/test-2) && echo $WALLET_3;
export WALLET_4=$(icad keys show wallet4 -a --keyring-backend test --home ./data/test-2) && echo $WALLET_4;

#setup ICA account from controller chain (chain 1 id test-1)
icad tx intertx register --from $WALLET_1 --connection-id connection-0 --chain-id test-1 --home ./data/test-1 --node tcp://localhost:16657 --keyring-backend test --timeout-height 1000

# Query the address of the interchain account
icad query intertx interchainaccounts connection-0 $WALLET_1 --home ./data/test-1 --node tcp://localhost:16657

# Store the interchain account address by parsing the query result: cosmos1hd0f4u7zgptymmrn55h3hy20jv2u0ctdpq23cpe8m9pas8kzd87smtf8al
export ICA_ADDR=$(icad query intertx interchainaccounts connection-0 $WALLET_1 --home ./data/test-1 --node tcp://localhost:16657 -o json | jq -r '.interchain_account_address') && echo $ICA_ADDR

# Show that there is no name registered
icad q nameservice list-whois --chain-id test-2 --home ./data/test-2 --node tcp://localhost:26657



# submit ICA tx to register a name domain under ICA address with bid = 200
icad tx intertx submit \
"{
    \"@type\":\"/cosmos.interchainaccounts.nameservice.MsgCmpBuy\",
    \"creator\": \"$ICA_ADDR\",
    \"name\":\"test.com\",
    \"bid\":\"200\",
    \"metadata\":\"test_meta_data\"
}" --connection-id connection-0 --from $WALLET_1 --chain-id test-1 --home ./data/test-1 --node tcp://localhost:16657 --keyring-backend test -y


# show that it's pending on host chain
icad q nameservice list-pending-buy --node tcp://localhost:26657
# show that it's not confirmed on host chain
icad q nameservice list-whois --node tcp://localhost:26657

# Automatic oracle listen to event: to be implemented
# Manual alternative
# On host chain, use oracle to callback host module and say NO / reject the buy
icad tx nameservice cmp-host-callback test.com:::$ICA_ADDR NO --chain-id test-2 --home ./data/test-2 --keyring-backend test --from $WALLET_2


# show that it's cleared on host chain
icad q nameservice list-pending-buy --node tcp://localhost:26657
icad q nameservice list-whois --node tcp://localhost:26657


# submit the same ICA tx to register a name domain under ICA address with bid = 200
icad tx intertx submit \
"{
    \"@type\":\"/cosmos.interchainaccounts.nameservice.MsgCmpBuy\",
    \"creator\": \"$ICA_ADDR\",
    \"name\":\"test.com\",
    \"bid\":\"200\",
    \"metadata\":\"test_meta_data\"
}" --connection-id connection-0 --from $WALLET_1 --chain-id test-1 --home ./data/test-1 --node tcp://localhost:16657 --keyring-backend test -y

# show that it's pending on host chain
icad q nameservice list-pending-buy --node tcp://localhost:26657
# show that it's not confirmed on host chain
icad q nameservice list-whois --node tcp://localhost:26657

# On host chain, use oracle to callback host module and say NO / reject the buy
icad tx nameservice cmp-host-callback test.com:::$ICA_ADDR YES --chain-id test-2 --home ./data/test-2 --keyring-backend test --from $WALLET_2


# show that it's accepted on host chain
icad q nameservice list-pending-buy --node tcp://localhost:26657
icad q nameservice list-whois --node tcp://localhost:26657


// Event sub
ws://localhost:26657/websocket
{
   "jsonrpc": "2.0",
   "method": "subscribe",
   "id": 0,
   "params": {
      "query":"tm.event = 'Tx'"
   }
}