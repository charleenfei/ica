make install
make init-golang-rly
make start-golang-rly

# open new terminal
# install pip package if not yet installed : pip3 install -r oracle/requirements.txt
# start oracle service
make start-oracle

# open new terminal
# Store the following account addresses within the current shell env
export WALLET_1=$(icad keys show wallet1 -a --keyring-backend test --home ./data/test-1) && echo $WALLET_1;
export WALLET_2=$(icad keys show wallet2 -a --keyring-backend test --home ./data/test-1) && echo $WALLET_2;
export WALLET_3=$(icad keys show wallet3 -a --keyring-backend test --home ./data/test-2) && echo $WALLET_3;
export WALLET_4=$(icad keys show wallet4 -a --keyring-backend test --home ./data/test-2) && echo $WALLET_4;


#setup ICA account from controller chain (chain 1 id test-1)
#if it doesn't work, just restart relayer
icad tx intertx register --from $WALLET_1 --connection-id connection-0 --chain-id test-1 --home ./data/test-1 --node tcp://localhost:16657 --keyring-backend test --timeout-height 1000 -y

# Query the address of the interchain account
icad query intertx interchainaccounts connection-0 $WALLET_1 --home ./data/test-1 --node tcp://localhost:16657

# Before moving forward, make sure there this step is successful. It should show 1 interchain account address

# Store the interchain account address by parsing the query result: cosmos1hd0f4u7zgptymmrn55h3hy20jv2u0ctdpq23cpe8m9pas8kzd87smtf8al
export ICA_ADDR=$(icad query intertx interchainaccounts connection-0 $WALLET_1 --home ./data/test-1 --node tcp://localhost:16657 -o json | jq -r '.interchain_account_address') && echo $ICA_ADDR

# Test controlelr verification module. Only KYC-ed account can send crosschain tx through the "controller" module
# By default, all account are not verified, will failed all.
# Noticed that we submit through module "controller" with custom verification, not using "intertx" anymore.

icad tx controller submit-tx \
"{
    \"@type\":\"/cosmos.interchainaccounts.nameservice.MsgCmpBuy\",
    \"creator\": \"$ICA_ADDR\",
    \"name\":\"testcontroller.com\",
    \"bid\":\"150\",
    \"metadata\":\"test_meta_data\"
}" connection-0 --from $WALLET_1 --chain-id test-1 --home ./data/test-1 --node tcp://localhost:16657 --keyring-backend test -y

# Check the Relayer terminal, there is no Crosschain TX being relayed, it stopped at the controller chain.
# Check the List item on Hostchain, It shoule be empty
icad q nameservice list-whois --chain-id test-2 --home ./data/test-2 --node tcp://localhost:26657

# cmp data on controller chain is still blank, reject all crosschain tx
icad q controller list-cmp-data --chain-id test-1 --home ./data/test-1 --node tcp://localhost:16657

# Simulate offchain process submits KYC info from offchain source for WALLET_1
icad tx controller cmp-controller-push $WALLET_1 true retail test_meta_data --from $WALLET_1 --chain-id test-1 --home ./data/test-1 --node tcp://localhost:16657 --keyring-backend test -y
icad q controller list-cmp-data --chain-id test-1 --home ./data/test-1 --node tcp://localhost:16657
# Submit the same Tx again, this time it should work
icad tx controller submit-tx \
"{
    \"@type\":\"/cosmos.interchainaccounts.nameservice.MsgCmpBuy\",
    \"creator\": \"$ICA_ADDR\",
    \"name\":\"testcontroller.com\",
    \"bid\":\"150\",
    \"metadata\":\"test_meta_data\"
}" connection-0 --from $WALLET_1 --chain-id test-1 --home ./data/test-1 --node tcp://localhost:16657 --keyring-backend test -y

# Show that there is only one name registered "testcontroller.com" (from the controller chain test)
icad q nameservice list-whois --chain-id test-2 --home ./data/test-2 --node tcp://localhost:26657


# workflow 1 : banned domain cannot be bought
# default configuration, ".country-x" domain is banned
# submit ICA tx to register a name domain ".country-x" under ICA address with bid = 200
icad tx controller submit-tx \
"{
    \"@type\":\"/cosmos.interchainaccounts.nameservice.MsgCmpBuy\",
    \"creator\": \"$ICA_ADDR\",
    \"name\":\"testdomain.country-x\",
    \"bid\":\"200\",
    \"metadata\":\"test_meta_data\"
}" connection-0 --from $WALLET_1 --chain-id test-1 --home ./data/test-1 --node tcp://localhost:16657 --keyring-backend test -y

# show that it's not showed on list-whois
icad q nameservice list-whois --node tcp://localhost:26657

# remove ".country-x" from the banned entries in the offchain file : cmp_config.json
# the banned entries should become like this "banned": [".xyz", ".abc", ".region-y"],

# submit ICA the same tx to register a name domain ".country-x" again, this time it is not banned
icad tx controller submit-tx \
"{
    \"@type\":\"/cosmos.interchainaccounts.nameservice.MsgCmpBuy\",
    \"creator\": \"$ICA_ADDR\",
    \"name\":\"testdomain.country-x\",
    \"bid\":\"200\",
    \"metadata\":\"test_meta_data\"
}" connection-0 --from $WALLET_1 --chain-id test-1 --home ./data/test-1 --node tcp://localhost:16657 --keyring-backend test -y

# show that the name is bought
icad q nameservice list-whois --node tcp://localhost:26657


# workflow 2 : Price control, certain domain has certain price range
# example in the cmp_config.json  ".org": [10,20], meaning domain .org can be bought with price between 10 and 20

# submit ICA the same tx to register a name domain ".org" with bid = 50, out side acceptable range
icad tx controller submit-tx \
"{
    \"@type\":\"/cosmos.interchainaccounts.nameservice.MsgCmpBuy\",
    \"creator\": \"$ICA_ADDR\",
    \"name\":\"testdomain.org\",
    \"bid\":\"50\",
    \"metadata\":\"test_meta_data\"
}" connection-0 --from $WALLET_1 --chain-id test-1 --home ./data/test-1 --node tcp://localhost:16657 --keyring-backend test -y

# show that it's not accepted, only tow domain "testcontroller.com", "testdomain.country-x" were registered
icad q nameservice list-whois --node tcp://localhost:26657

# Change the cmp_config.json  ".org": [10,200], meaning domain .org can be bought with price between 10 and 200
# submit the same tx again, this time it should be accepted.
icad tx controller submit-tx \
"{
    \"@type\":\"/cosmos.interchainaccounts.nameservice.MsgCmpBuy\",
    \"creator\": \"$ICA_ADDR\",
    \"name\":\"testdomain.org\",
    \"bid\":\"50\",
    \"metadata\":\"test_meta_data\"
}" connection-0 --from $WALLET_1 --chain-id test-1 --home ./data/test-1 --node tcp://localhost:16657 --keyring-backend test -y

# show that it's accepted, 3 domains "testcontroller.com", "testdomain.country-x" and "testdomain.org" were registered
icad q nameservice list-whois --node tcp://localhost:26657

# What will happens if oracle is offline. Tx will be in pending list and never be cleared
# Close the oracle process `oracle/simple_oracle.py` earlier

icad tx controller submit-tx \
"{
    \"@type\":\"/cosmos.interchainaccounts.nameservice.MsgCmpBuy\",
    \"creator\": \"$ICA_ADDR\",
    \"name\":\"my_domain.com\",
    \"bid\":\"50\",
    \"metadata\":\"test_meta_data\"
}" connection-0 --from $WALLET_1 --chain-id test-1 --home ./data/test-1 --node tcp://localhost:16657 --keyring-backend test -y

# show that it's not accepted, only 3 domains "testcontroller.com", "testdomain.country-x" and "testdomain.org" were registered
icad q nameservice list-whois --node tcp://localhost:26657
# show that there is a pending item waiting for cmp result: item "my_domain.com"
icad q nameservice list-pending-buy --node tcp://localhost:26657


icad tx controller submit-tx \
"{
    \"@type\":\"/cosmos.interchainaccounts.nameservice.MsgQueryCmpStatus\",
    \"creator\": \"$ICA_ADDR\",
    \"request\":\"my_test_request\"
}" connection-0 --from $WALLET_1 --chain-id test-1 --home ./data/test-1 --node tcp://localhost:16657 --keyring-backend test -y
